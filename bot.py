import os
import logging
import json
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters
import openai
import gspread
from google.oauth2.service_account import Credentials
from google.cloud import vision
import re

# Настраиваем логирование
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Настройка OpenAI API
openai_api_key = os.getenv("OPENAI_API_KEY")
if not openai_api_key:
    logger.error("Ошибка: OPENAI_API_KEY не найден.")
    exit(1)
openai.api_key = openai_api_key

# Настройка Google Sheets
SPREADSHEET_ID = "1FlGPuIRdPcN2ACOQXQaesawAMtgOqd90vdk4f0PlUks"

# Словарь синонимов анализов
ANALYSIS_SYNONYMS = {
    "анализ мочи по зимницкому ручным методом": ["зимницкий моча", "моча зимницкий", "анализ мочи зимницкого", "зимницкий анализ"],
    "анализ мочи по нечипоренко ручным методом": ["нечипоренко моча", "моча нечипоренко", "анализ мочи нечипоренко", "нечипоренко анализ"],
    "проба реберга ручным методом": ["анализ реберга", "реберг", "реберг анализ", "проба реберга"],
    "исследование кала на простейшие и гельминты ручными методами": ["кал на яйцеглист", "анализ кала гельминты", "кал простейшие", "гельминты анализ"],
    "исследование урогенитального мазка ручным методом": ["урогенитальный мазок", "анализ урогенитальный мазок", "урогенитальный соскоб", "мазок урогенитальный"],
    "исследование секрета простаты ручным методом": ["секрет простаты", "анализ простаты", "анализ секрета простаты", "простата секрет"],
    "исследование семенной жидкости (исследование спермы) ручным методом": ["спермограмма", "анализ спермы", "исследование семенной жидкости", "сперма анализ"],
    "исследование кала (копрограмма) общеклиническое ручным методом": ["копрограмма", "анализ кала общеклинический", "кал общий", "кал анализ"],
    "определение степени чистоты гинекологического мазка ручным методом": ["степень чистоты мазка", "анализ гинекологического мазка", "чистота мазка", "гинекологический мазок"],
    "исследования биологического материала на демодекоз ручным методом": ["демодекоз", "анализ демодекоз", "демодекс", "исследование на демодекоз"],
    "исследование перианального соскоба ручным методом": ["перианальный соскоб", "анализ перианальный соскоб", "соскоб перианальный", "перианальный анализ"],
    "риноцитограмма соскоба из слизистой оболочки носовой полости": ["риноцитограмма", "анализ риноцитограмма", "соскоб из носа", "носовой соскоб"],
    "оам (общий анализ мочи)": ["оам", "анализ мочи", "моча общий", "анализ общий мочи"],
    "определение белка в моче (количественно) на анализаторе": ["белок мочи", "анализ белка мочи", "моча белок", "белок в моче"],
    "определение глюкозы в суточной моче на анализаторе": ["глюкоза мочи", "анализ глюкозы мочи", "моча глюкоза", "глюкоза в моче"],
    "определение желчных пигментов в моче на анализаторе": ["желчные пигменты мочи", "анализ желчных пигментов", "моча желчные пигменты", "пигменты в моче"],
    "определение кетоновых тел в моче на анализаторе": ["кетоновые тела мочи", "анализ кетоновых тел", "моча кетоновые тела", "кетоны в моче"],
    "соэ (скорость оседания эритроцитов)": ["соэ", "скорость оседания эритроцитов", "анализ соэ", "эритроциты оседание"],
    "подсчет лейкоформулы в крови ручным методом": ["лейкоформула", "анализ лейкоформула", "лейкоформула ручной", "лейкоформула подсчет"],
    "подсчет ретикулоцитов в крови ручным методом": ["ретикулоциты", "ретикулоциты подсчет", "анализ ретикулоцитов", "ретикулоциты ручной"],
    "подсчет тромбоцитов в крови ручным методом": ["тромбоциты", "тромбоциты подсчет", "анализ тромбоциты", "тромбоциты ручной"],
    "оак (общий анализ крови) + соэ (скорость оседания эритроцитов)": ["оак", "общий анализ крови", "анализ крови общий", "кровь общий"],
    "тимоловая проба в сыворотке крови ручным методом": ["тимоловая проба", "анализ тимоловой пробы", "тимоловая сыворотка", "тимоловая кровь"],
    "алт": ["аланинаминотрансфераза", "анализ алт", "алт биохимия", "алт кровь"],
    "аст": ["аспартатаминотрансфераза", "анализ аст", "аст биохимия", "аст кровь"],
    "альбумин": ["анализ альбумин", "альбумин кровь", "альбумин сыворотка", "альбумин биохимия"],
    "общий белок": ["белок общий", "анализ белка общий", "белок крови", "общий белок сыворотка"],
    "билирубин общий": ["общий билирубин", "анализ билирубина", "билирубин кровь", "билирубин сыворотка"],
    "билирубин прямой": ["прямой билирубин", "анализ прямого билирубина", "билирубин прямой кровь", "билирубин прямой сыворотка"],
    "щелочная фосфотаза": ["анализ щелочной фосфотазы", "щелочная фосфотаза кровь", "щелочная фосфотаза сыворотка", "фосфотаза щелочная"],
    "кислая фосфотаза": ["анализ кислой фосфотазы", "кислая фосфотаза кровь", "кислая фосфотаза сыворотка", "фосфотаза кислая"],
    "креатинфосфокиназы (кфк)": ["кфк", "анализ кфк", "креатинфосфокиназа", "кфк кровь"],
    "креатинфосфокиназы фракция мв (кфк-мв)": ["кфк-мв", "анализ кфк-мв", "креатинфосфокиназа мв", "кфк-мв кровь"],
    "ггтп": ["гамма-глутамилтрансфераза", "анализ ггтп", "ггтп кровь", "ггтп сыворотка"],
    "лдг": ["лактатдегидрогеназа", "анализ лдг", "лдг кровь", "лдг сыворотка"],
    "липаза": ["анализ липазы", "липаза кровь", "липаза сыворотка", "липаза биохимия"],
    "калий, натрий, хлор": ["электролиты", "анализ электролитов", "калий натрий хлор", "электролиты кровь"],
    "кальций ионизированный": ["ионизированный кальций", "анализ кальция ионизированного", "кальций ионизированный кровь", "кальций ионизированный сыворотка"],
    "кальций (ca)": ["кальций", "анализ кальция", "кальций кровь", "кальций сыворотка"],
    "магний (mg)": ["магний", "анализ магния", "магний кровь", "магний сыворотка"],
    "фосфор (p)": ["фосфор", "анализ фосфора", "фосфор кровь", "фосфор сыворотка"],
    "селен": ["анализ селена", "селен кровь", "селен сыворотка", "селен микроэлемент"],
    "йод": ["анализ йода", "йод кровь", "йод сыворотка", "йод микроэлемент"],
    "цинк": ["анализ цинка", "цинк кровь", "цинк сыворотка", "цинк микроэлемент"],
    "железо (fe)": ["железо", "анализ железа", "железо кровь", "железо сыворотка"],
    "общая железосвязывающая способность (ожсс)": ["ожсс", "анализ ожсс", "железосвязывающая способность", "ожсс кровь"],
    "общий холестерин": ["холестерин", "анализ холестерина", "холестерин кровь", "холестерин сыворотка"],
    "определение липопротеидов высокой плотности в сыворотке крови на анализаторе (лпвп)": ["лпвп", "анализ лпвп", "липопротеиды высокой плотности", "лпвп кровь"],
    "определение липопротеидов низкой плотности в сыворотке крови на анализаторе (лпнп)": ["лпнп", "анализ лпнп", "липопротеиды низкой плотности", "лпнп кровь"],
    "триглицериды": ["анализ триглицеридов", "триглицериды кровь", "триглицериды сыворотка", "триглицериды биохимия"],
    "глюкоза": ["сахар", "глюкоза кровь", "уровень сахара", "глюкоза анализ"],
    "мочевина крови": ["мочевина", "анализ мочевины", "мочевина кровь", "мочевина сыворотка"],
    "креатинин крови": ["креатинин", "анализ креатинина", "креатинин кровь", "креатинин сыворотка"],
    "мочевая кислота": ["анализ мочевой кислоты", "мочевая кислота кровь", "мочевая кислота сыворотка", "мочевая кислота биохимия"],
    "трансферрин": ["анализ трансферрина", "трансферрин кровь", "трансферрин сыворотка", "трансферрин биохимия"],
    "альфа-амилаза": ["амилаза", "анализ амилазы", "альфа-амилаза кровь", "альфа-амилаза сыворотка"],
    "панкреатическая амилаза": ["амилаза панкреатическая", "анализ панкреатической амилазы", "панкреатическая амилаза кровь", "панкреатическая амилаза сыворотка"],
    "гликозилированный гемоглобин": ["гликированный гемоглобин", "анализ гликозилированного гемоглобина", "гемоглобин гликозилированный", "гликированный гемоглобин кровь"],
    "«c» реактивный белок (срб)": ["срб", "анализ срб", "c-реактивный белок", "срб кровь"],
    "антистрептолизин «o» (асло)": ["асло", "анализ асло", "антистрептолизин о", "асло кровь"],
    "определение времени свертывания крови ручным методом": ["время свертывания крови", "анализ свертываемости крови", "свертываемость крови", "время свертывания"],
    "рфмк": ["растворимые фибрин-мономерные комплексы", "анализ рфмк", "рфмк кровь", "рфмк свертываемость"],
    "коагулограмма: ачтв, пв-пти-мно, фибриноген, тв": ["коагулограмма", "анализ коагулограммы", "коагулограмма кровь", "коагулограмма свертываемость"],
    "ачтв": ["активированное частичное тромбопластиновое время", "анализ ачтв", "ачтв кровь", "ачтв свертываемость"],
    "пв-пти-мно": ["протромбиновое время", "анализ пв-пти-мно", "пв-пти-мно кровь", "пв-пти-мно свертываемость"],
    "тромбиновое время (тв)": ["тв", "анализ тв", "тромбиновое время", "тв кровь"],
    "d - димер": ["димер", "анализ d-димера", "d-димер кровь", "димер свертываемость"],
    "волчаночный антикоагулянт": ["анализ волчаночного антикоагулянта", "волчаночный антикоагулянт кровь", "волчаночный антикоагулянт свертываемость", "антикоагулянт волчаночный"],
    "фибриноген": ["анализ фибриногена", "фибриноген кровь", "фибриноген свертываемость", "фибриноген сыворотка"],
    "рф-суммарный (количественный)": ["ревматоидный фактор", "анализ рф", "рф кровь", "рф сыворотка"],
    "гомоцистеин": ["анализ гомоцистеина", "гомоцистеин кровь", "гомоцистеин сыворотка", "гомоцистеин биохимия"],
    "ферритин": ["анализ ферритина", "ферритин кровь", "ферритин сыворотка", "ферритин биохимия"],
    "эозинофильный катионный белок (ecp)": ["ecp", "анализ ecp", "эозинофильный катионный белок", "ecp кровь"],
    "витамина d": ["витамин d", "анализ витамина d", "витамин d кровь", "витамин d сыворотка"],
    "витамина b 12": ["витамин b12", "анализ витамина b12", "витамин b12 кровь", "витамин b12 сыворотка"],
    "фолиевая кислота": ["анализ фолиевой кислоты", "фолиевая кислота кровь", "фолиевая кислота сыворотка", "фолиевая кислота биохимия"],
    "антитела к тиреопероксидазе (ат-тпо)": ["ат-тпо", "анализ ат-тпо", "антитела к тпо", "ат-тпо кровь"],
    "антитела к тиреоглобулину (ат к тг)": ["ат к тг", "анализ ат к тг", "антитела к тиреоглобулину", "ат к тг кровь"],
    "свободный тироксин (t4)": ["т4 свободный", "анализ т4 свободного", "тироксин свободный", "т4 свободный кровь"],
    "свободный трийодтиронин (t3)": ["т3 свободный", "анализ т3 свободного", "трийодтиронин свободный", "т3 свободный кровь"],
    "общий трииодтиронин (t3)": ["т3 общий", "анализ т3 общего", "трийодтиронин общий", "т3 общий кровь"],
    "тиреотропный гормон (ттг)": ["ттг", "анализ ттг", "тиреотропный гормон", "ттг кровь"],
    "общий тироксин (t4)": ["т4 общий", "анализ т4 общего", "тироксин общий", "т4 общий кровь"],
    "тиреоглобулин (тг)": ["тг", "анализ тг", "тиреоглобулин", "тг кровь"],
    "антитела к рецепторам ттг": ["антитела к ттг", "анализ антител к ттг", "антитела к рецепторам ттг", "антитела к ттг кровь"],
    "фолликулостимулирующий гормон (фсг)": ["фсг", "анализ фсг", "фолликулостимулирующий гормон", "фсг кровь"],
    "лютеинизирующий гормон (лг)": ["лг", "анализ лг", "лютеинизирующий гормон", "лг кровь"],
    "пролактин": ["анализ пролактина", "пролактин кровь", "пролактин сыворотка", "пролактин гормон"],
    "макропролактин": ["анализ макропролактина", "макропролактин кровь", "макропролактин сыворотка", "макропролактин гормон"],
    "кортизол": ["анализ кортизола", "кортизол кровь", "кортизол сыворотка", "кортизол гормон"],
    "прогестерон": ["анализ прогестерона", "прогестерон кровь", "прогестерон сыворотка", "прогестерон гормон"],
    "эстрадиол": ["анализ эстрадиола", "эстрадиол кровь", "эстрадиол сыворотка", "эстрадиол гормон"],
    "тестостерон": ["анализ тестостерона", "тестостерон кровь", "тестостерон сыворотка", "тестостерон гормон"],
    "свободный тестостерон": ["анализ свободного тестостерона", "свободный тестостерон кровь", "свободный тестостерон сыворотка", "свободный тестостерон гормон"],
    "гспг": ["глобулин, связывающий половые гормоны", "анализ гспг", "гспг кровь", "гспг сыворотка"],
    "лептин": ["анализ лептина", "лептин кровь", "лептин сыворотка", "лептин гормон"],
    "?-хорионический гонадотропин человека (?-хгч)": ["хгч", "анализ хгч", "хорионический гонадотропин", "хгч кровь"],
    "анти мюллеров гормон (амг)": ["амг", "анализ амг", "антимюллеров гормон", "амг кровь"],
    "инсулин": ["анализ инсулина", "инсулин кровь", "инсулин сыворотка", "инсулин гормон"],
    "c-пептид": ["анализ c-пептида", "c-пептид кровь", "c-пептид сыворотка", "c-пептид гормон"],
    "соматотропный гормон (стг)": ["стг", "анализ стг", "соматотропный гормон", "стг кровь"],
    "ифр-1 (соматомедин 1)": ["ифр-1", "анализ ифр-1", "соматомедин 1", "ифр-1 кровь"],
    "актг": ["адренокортикотропный гормон", "анализ актг", "актг кровь", "актг гормон"],
    "дегидроэпиандростерон (дгэа)": ["дгэа", "анализ дгэа", "дегидроэпиандростерон", "дгэа кровь"],
    "17- оксипрогестерон": ["17-оп", "анализ 17-оксипрогестерона", "17-оксипрогестерон", "17-оп кровь"],
    "альдостерон": ["анализ альдостерона", "альдостерон кровь", "альдостерон сыворотка", "альдостерон гормон"],
    "паратгормон": ["анализ паратгормона", "паратгормон кровь", "паратгормон сыворотка", "паратгормон гормон"],
    "кальцитонин": ["анализ кальцитонина", "кальцитонин кровь", "кальцитонин сыворотка", "кальцитонин гормон"],
    "прокальцитонин": ["анализ прокальцитонина", "прокальцитонин кровь", "прокальцитонин сыворотка", "прокальцитонин гормон"],
    "ig a (общий)": ["iga", "анализ iga", "иммуноглобулин a", "iga кровь"],
    "ig e (общий)": ["ige", "анализ ige", "иммуноглобулин e", "ige кровь"],
    "ig g (общий)": ["igg", "анализ igg", "иммуноглобулин g", "igg кровь"],
    "ig m (общий)": ["igm", "анализ igm", "иммуноглобулин m", "igm кровь"],
    "суммарные антитела к циклическим цитруллиновым пептидам (ацпп)": ["ацпп", "анализ ацпп", "антитела к циклическим цитруллиновым пептидам", "ацпп кровь"],
    "антинейтрофильные цитоплазматические ig g (anca combi)": ["anca", "анализ anca", "антинейтрофильные цитоплазматические антитела", "anca кровь"],
    "антиядерные аутоантитела (ana)": ["ana", "анализ ana", "антиядерные антитела", "ana кровь"],
    "аутоиммунные ig g к двуспиральной днк": ["антитела к днк", "анализ антител к днк", "аутоиммунные антитела к днк", "антитела к днк кровь"],
    "цитокины-ил-6": ["ил-6", "анализ ил-6", "интерлейкин 6", "ил-6 кровь"],
    "анти-фосфолипидные антитела ig g": ["антифосфолипидные антитела", "анализ антифосфолипидных антител", "антифосфолипидные антитела igg", "антифосфолипидные антитела кровь"],
    "анти-фосфолипидные антитела ig m": ["антифосфолипидные антитела igm", "анализ антифосфолипидных антител igm", "антифосфолипидные антитела igm кровь"],
    "антитела к кардиолипину (ig g, ig m)": ["антитела к кардиолипину", "анализ антител к кардиолипину", "кардиолипин антитела", "антитела к кардиолипину кровь"],
    "антиядерный фактор на hep-2 клетках": ["антиядерный фактор", "анализ антиядерного фактора", "антиядерный фактор hep-2", "антиядерный фактор кровь"],
    "афп (альфафетопротеин)": ["афп", "анализ афп", "альфафетопротеин", "афп кровь"],
    "опухолевый антиген (са 125)": ["са 125", "анализ са 125", "онкомаркер са 125", "са 125 кровь"],
    "опухолевый антиген (са 15-3)": ["са 15-3", "анализ са 15-3", "онкомаркер са 15-3", "са 15-3 кровь"],
    "опухолевый антиген (са 19-9)": ["са 19-9", "анализ са 19-9", "онкомаркер са 19-9", "са 19-9 кровь"],
    "опухолевый антиген (са 72-4)": ["са 72-4", "анализ са 72-4", "онкомаркер са 72-4", "са 72-4 кровь"],
    "раковый эмбриональный антиген (рэа)": ["рэа", "анализ рэа", "онкомаркер рэа", "рэа кровь"],
    "свободный пса (f-простат-специфический антиген)": ["f-psa", "анализ f-psa", "свободный пса", "f-psa кровь"],
    "общий простат-специфический антиген (пса)": ["пса", "анализ пса", "простат-специфический антиген", "пса кровь"],
    "опухолевый маркер рака яичников (he-4)": ["he-4", "анализ he-4", "онкомаркер he-4", "he-4 кровь"],
    "онкомаркер немелкоклеточного рака легких (cyfra 21-1)": ["cyfra 21-1", "анализ cyfra 21-1", "онкомаркер cyfra 21-1", "cyfra 21-1 кровь"],
    "s100": ["анализ s100", "s100 кровь", "s100 онкомаркер", "s100 сыворотка"],
    "nse": ["анализ nse", "nse кровь", "nse онкомаркер", "nse сыворотка"],
    "scca": ["анализ scca", "scca кровь", "scca онкомаркер", "scca сыворотка"],
    "диагностика хронической сердечной недостаточности pro-bnp (натрийуретические пептиды)": ["pro-bnp", "анализ pro-bnp", "натрийуретические пептиды", "pro-bnp кровь"],
    "тропонин i": ["анализ тропонина i", "тропонин i кровь", "тропонин i сыворотка", "тропонин i кардиомаркер"],
    "гепатит в hbsag (австралийский)": ["hbsag", "анализ hbsag", "австралийский антиген", "hbsag кровь"],
    "гепатит в anti-hbcag (igg)": ["anti-hbcag igg", "анализ anti-hbcag igg", "антитела к hbcag igg", "anti-hbcag igg кровь"],
    "гепатит в anti-hbcag (igm)": ["anti-hbcag igm", "анализ anti-hbcag igm", "антитела к hbcag igm", "anti-hbcag igm кровь"],
    "гепатит в hbeag": ["hbeag", "анализ hbeag", "антиген hbeag", "hbeag кровь"],
    "гепатит в anti-hbeag (igg)": ["anti-hbeag igg", "анализ anti-hbeag igg", "антитела к hbeag igg", "anti-hbeag igg кровь"],
    "гепатит с anti-hcv (ig g, ig m)": ["anti-hcv", "анализ anti-hcv", "антитела к hcv", "anti-hcv кровь"],
    "гепатит а anti-hav (igm)": ["anti-hav igm", "анализ anti-hav igm", "антитела к hav igm", "anti-hav igm кровь"],
    "вирусный гепатит д (a-hdv total)": ["a-hdv", "анализ a-hdv", "антитела к hdv", "a-hdv кровь"],
    "ig g к капсидному антигену вируса эпштеин-барра (впг-iv)": ["антитела к впг-iv", "анализ антител к впг-iv", "впг-iv igg", "антитела к впг-iv кровь"],
    "ig m к капсидному антигену вируса эпштеин-барра (впг-iv)": ["антитела к впг-iv igm", "анализ антител к впг-iv igm", "впг-iv igm", "антитела к впг-iv igm кровь"],
    "ig g к ядерному антигену вируса эпштеин-барра (впг-iv)": ["антитела к ядерному антигену впг-iv", "анализ антител к ядерному антигену впг-iv", "впг-iv ядерный антиген igg", "антитела к ядерному антигену впг-iv кровь"],
    "igg к раннему антигену вируса эпштеин-барра (впг-iv)": ["антитела к раннему антигену впг-iv", "анализ антител к раннему антигену впг-iv", "впг-iv ранний антиген igg", "антитела к раннему антигену впг-iv кровь"],
    "ig g к цитомегаловирусу (впг-v)": ["антитела к цитомегаловирусу", "анализ антител к цитомегаловирусу", "цитомегаловирус igg", "антитела к цитомегаловирусу кровь"],
    "ig m к цитомегаловирусу (впг-v)": ["антитела к цитомегаловирусу igm", "анализ антител к цитомегаловирусу igm", "цитомегаловирус igm", "антитела к цитомегаловирусу igm кровь"],
    "вирус простого герпеса 1, 2 тип (впг-i,ii) (igg)": ["антитела к впг-i,ii igg", "анализ антител к впг-i,ii igg", "впг-i,ii igg", "антитела к впг-i,ii igg кровь"],
    "вирус простого герпеса 1, 2 тип (впг-i,ii) (igm)": ["антитела к впг-i,ii igm", "анализ антител к впг-i,ii igm", "впг-i,ii igm", "антитела к впг-i,ii igm кровь"],
    "ig g к возбудителю краснухи": ["антитела к краснухе", "анализ антител к краснухе", "краснуха igg", "антитела к краснухе кровь"],
    "ig m к возбудителю краснухи": ["антитела к краснухе igm", "анализ антител к краснухе igm", "краснуха igm", "антитела к краснухе igm кровь"],
    "авидность антител igg к впг 1, 2 тип": ["авидность впг 1, 2", "анализ авидности впг 1, 2", "впг 1, 2 авидность", "авидность впг 1, 2 кровь"],
    "авидность антител igg к цмв": ["авидность цмв", "анализ авидности цмв", "цмв авидность", "авидность цмв кровь"],
    "авидность igg к краснухе": ["авидность краснухи", "анализ авидности краснухи", "краснуха авидность", "авидность краснухи кровь"],
    "антитела к короновирусу sars-cov-2 (covid-19), спайковый (s) белок, igg, количественный": ["антитела к covid-19", "анализ антител к covid-19", "covid-19 igg", "антитела к covid-19 кровь"],
    "токсоплазмоз (toxoplasma gondii) ig g": ["антитела к токсоплазмозу igg", "анализ антител к токсоплазмозу igg", "токсоплазмоз igg", "антитела к токсоплазмозу igg кровь"],
    "токсоплазмоз (toxoplasma gondii) ig m": ["антитела к токсоплазмозу igm", "анализ антител к токсоплазмозу igm", "токсоплазмоз igm", "антитела к токсоплазмозу igm кровь"],
    "листериоз ig g": ["антитела к листериозу igg", "анализ антител к листериозу igg", "листериоз igg", "антитела к листериозу igg кровь"],
    "бруцеллез ig g": ["антитела к бруцеллезу igg", "анализ антител к бруцеллезу igg", "бруцеллез igg", "антитела к бруцеллезу igg кровь"],
    "бруцеллез ig a": ["антитела к бруцеллезу iga", "анализ антител к бруцеллезу iga", "бруцеллез iga", "антитела к бруцеллезу iga кровь"],
    "иерсинии (yersinia enterocolotica) ig g": ["антитела к иерсиниям igg", "анализ антител к иерсиниям igg", "иерсинии igg", "антитела к иерсиниям igg кровь"],
    "хеликобактер пилори (helicobacter pylori) ig a": ["антитела к хеликобактеру iga", "анализ антител к хеликобактеру iga", "хеликобактер iga", "антитела к хеликобактеру iga кровь"],
    "хеликобактер пилори (helicobacter pylori) ig g": ["антитела к хеликобактеру igg", "анализ антител к хеликобактеру igg", "хеликобактер igg", "антитела к хеликобактеру igg кровь"],
    "аскаридоз (??ascaris lumbricoide) ig g": ["антитела к аскаридам igg", "анализ антител к аскаридам igg", "аскариды igg", "антитела к аскаридам igg кровь"],
    "аспергиллез (aspergillus fumigatus), igg": ["антитела к аспергиллезу igg", "анализ антител к аспергиллезу igg", "аспергиллез igg", "антитела к аспергиллезу igg кровь"],
    "лямблиоз (giardia intestinalis) ig a": ["антитела к лямблиям iga", "анализ антител к лямблиям iga", "лямблии iga", "антитела к лямблиям iga кровь"],
    "лямблиоз (giardia intestinalis) ig g": ["антитела к лямблиям igg", "анализ антител к лямблиям igg", "лямблии igg", "антитела к лямблиям igg кровь"],
    "описторхоз (opisthorchis felineus, opisthorchis viverrini) ig g": ["антитела к описторхозу igg", "анализ антител к описторхозу igg", "описторхоз igg", "антитела к описторхозу igg кровь"],
    "токсокароз (toxocara canis) ig g": ["антитела к токсокарозу igg", "анализ антител к токсокарозу igg", "токсокароз igg", "антитела к токсокарозу igg кровь"],
    "трихинеллез (trichinella spiralis) ig g": ["антитела к трихинеллезу igg", "анализ антител к трихинеллезу igg", "трихинеллез igg", "антитела к трихинеллезу igg кровь"],
    "эхинококк (echinococcus) ig g": ["антитела к эхинококку igg", "анализ антител к эхинококку igg", "эхинококк igg", "антитела к эхинококку igg кровь"],
    "treponema pallidum (трепанема паллидум) ig g": ["антитела к сифилису igg", "анализ антител к сифилису igg", "сифилис igg", "антитела к сифилису igg кровь"],
    "treponema pallidum (трепанема паллидум) ig m": ["антитела к сифилису igm", "анализ антител к сифилису igm", "сифилис igm", "антитела к сифилису igm кровь"],
    "суммарные антитела к treponema pallidum (трепанема паллидум)": ["антитела к сифилису суммарные", "анализ антител к сифилису суммарных", "сифилис суммарные антитела", "антитела к сифилису суммарные кровь"],
    "chlamydia pneumoniae (хламидиа пнеумоние) ig g": ["антитела к хламидии пневмонии igg", "анализ антител к хламидии пневмонии igg", "хламидия пневмония igg", "антитела к хламидии пневмонии igg кровь"],
    "chlamydia pneumoniae (хламидиа пнеумоние) ig m": ["антитела к хламидии пневмонии igm", "анализ антител к хламидии пневмонии igm", "хламидия пневмония igm", "антитела к хламидии пневмонии igm кровь"],
    "chlamydia trachomatis (хламидиа трахоматис) ig m": ["антитела к хламидии трахоматис igm", "анализ антител к хламидии трахоматис igm", "хламидия трахоматис igm", "антитела к хламидии трахоматис igm кровь"],
    "chlamydia trachomatis (хламидиа трахоматис) ig g": ["антитела к хламидии трахоматис igg", "анализ антител к хламидии трахоматис igg", "хламидия трахоматис igg", "антитела к хламидии трахоматис igg кровь"],
    "gardnerella vaginalis (гарднерелла вагиналис) ig g": ["антитела к гарднерелле igg", "анализ антител к гарднерелле igg", "гарднерелла igg", "антитела к гарднерелле igg кровь"],
    "gardnerella vaginalis (гарднерелла вагиналис) ig m": ["антитела к гарднерелле igm", "анализ антител к гарднерелле igm", "гарднерелла igm", "антитела к гарднерелле igm кровь"],
    "mycoplasma hominis (микоплазма хоминис) ig g": ["антитела к микоплазме хоминис igg", "анализ антител к микоплазме хоминис igg", "микоплазма хоминис igg", "антитела к микоплазме хоминис igg кровь"],
    "mycoplasma hominis (микоплазма хоминис) ig м": ["антитела к микоплазме хоминис igm", "анализ антител к микоплазме хоминис igm", "микоплазма хоминис igm", "антитела к микоплазме хоминис igm кровь"],
    "trichomonas vaginalis (трихомонас вагиналис) ig g": ["антитела к трихомонасу igg", "анализ антител к трихомонасу igg", "трихомонас igg", "антитела к трихомонасу igg кровь"],
    "trichomonas vaginalis (трихомонас вагиналис) ig м": ["антитела к трихомонасу igm", "анализ антител к трихомонасу igm", "трихомонас igm", "антитела к трихомонасу igm кровь"],
    "ureaplasma urealyticum (уреаплазма уреалитикум) ig м": ["антитела к уреаплазме igm", "анализ антител к уреаплазме igm", "уреаплазма igm", "антитела к уреаплазме igm кровь"],
    "ureaplasma urealyticum (уреаплазма уреалитикум) ig g": ["антитела к уреаплазме igg", "анализ антител к уреаплазме igg", "уреаплазма igg", "антитела к уреаплазме igg кровь"],
    "candida (кандида) ig g": ["антитела к кандиде igg", "анализ антител к кандиде igg", "кандида igg", "антитела к кандиде igg кровь"],
    "candida (кандида) ig m": ["антитела к кандиде igm", "анализ антител к кандиде igm", "кандида igm", "антитела к кандиде igm кровь"],
    "гонорея ig g": ["антитела к гонорее igg", "анализ антител к гонорее igg", "гонорея igg", "антитела к гонорее igg кровь"],
    "суммарные антитела к вич-1,2 и антигену p24": ["антитела к вич", "анализ антител к вич", "вич суммарные антитела", "антитела к вич кровь"],
    "группа крови": ["анализ группы крови", "группа крови", "определение группы крови", "группа крови анализ"],
    "резус-фактора": ["анализ резус-фактора", "резус-фактор", "определение резус-фактора", "резус-фактор анализ"],
    "постановка реакции микропреципитации с кардиолипиновым антигеном в сыворотке крови ручным методом": ["микропреципитация", "анализ микропреципитации", "кардиолипиновый антиген", "микропреципитация кровь"],
    "постановка реакции вассермана в сыворотке крови ручным методом": ["реакция вассермана", "анализ реакции вассермана", "вассерман", "реакция вассермана кровь"],
    "реакция райта-хеддельсона бруцеллез": ["реакция райта-хеддельсона", "анализ реакции райта-хеддельсона", "бруцеллез реакция", "реакция райта-хеддельсона кровь"],
    "candida spp. (кандида)": ["кандида spp", "анализ кандида spp", "кандида spp кровь", "кандида spp пцр"],
    "chlamydia spp. (хламидиа)": ["хламидия spp", "анализ хламидия spp", "хламидия spp кровь", "хламидия spp пцр"],
    "gardnerella vaginalis (гарднерелла вагиналис)": ["гарднерелла вагиналис", "анализ гарднерелла вагиналис", "гарднерелла вагиналис кровь", "гарднерелла вагиналис пцр"],
    "mycoplasma hominis (микоплазма хоминис)": ["микоплазма хоминис", "анализ микоплазма хоминис", "микоплазма хоминис кровь", "микоплазма хоминис пцр"],
    "mycoplasma genitalium (микоплазма гениталиум)": ["микоплазма гениталиум", "анализ микоплазма гениталиум", "микоплазма гениталиум кровь", "микоплазма гениталиум пцр"],
    "neisseria gonorrhea (нейссериа гонореа)": ["нейссерия гонорея", "анализ нейссерия гонорея", "нейссерия гонорея кровь", "нейссерия гонорея пцр"],
    "toxoplasma gondii (токсоплазма гондии)": ["токсоплазма гондии", "анализ токсоплазма гондии", "токсоплазма гондии кровь", "токсоплазма гондии пцр"],
    "trichomonas vaginalis (трихомонас вагиналис)": ["трихомонас вагиналис", "анализ трихомонас вагиналис", "трихомонас вагиналис кровь", "трихомонас вагиналис пцр"],
    "ureaplasma urealyticum (уреаплазма уреалитикум)": ["уреаплазма уреалитикум", "анализ уреаплазма уреалитикум", "уреаплазма уреалитикум кровь", "уреаплазма уреалитикум пцр"],
    "вирус простого герпеса 1 и 2 типов, качественный": ["впг 1 и 2", "анализ впг 1 и 2", "впг 1 и 2 кровь", "впг 1 и 2 пцр"],
    "вирус папилломы человека 16": ["впч 16", "анализ впч 16", "впч 16 кровь", "впч 16 пцр"],
    "вирус папилломы человека 18": ["впч 18", "анализ впч 18", "впч 18 кровь", "впч 18 пцр"],
    "впч генотипирование (16,18,31,33,35,39,45,51,52,56,58,59)": ["впч генотипирование", "анализ впч генотипирования", "впч генотипирование кровь", "впч генотипирование пцр"],
    "впч генотипирование (6,11,44,16,18,26,31,33,35,39,45,51,52,53,56,58,59,66,68,73,82)": ["впч генотипирование расширенное", "анализ впч генотипирования расширенного", "впч генотипирование расширенное кровь", "впч генотипирование расширенное пцр"],
    "гепатит b, качественный": ["гепатит b качественный", "анализ гепатита b качественный", "гепатит b качественный кровь", "гепатит b качественный пцр"],
    "гепатита c, качественный": ["гепатит c качественный", "анализ гепатита c качественный", "гепатит c качественный кровь", "гепатит c качественный пцр"],
    "гепатит b, количественный": ["гепатит b количественный", "анализ гепатита b количественный", "гепатит b количественный кровь", "гепатит b количественный пцр"],
    "гепатита c, количественный": ["гепатит c количественный", "анализ гепатита c количественный", "гепатит c количественный кровь", "гепатит c количественный пцр"],
    "пцр covid-19": ["covid-19 пцр", "анализ covid-19 пцр", "covid-19 пцр кровь", "covid-19 пцр мазок"],
    "цитомегаловирус (впг-v)": ["цитомегаловирус", "анализ цитомегаловируса", "цитомегаловирус кровь", "цитомегаловирус пцр"],
    "listeria (листериа)": ["листерия", "анализ листерии", "листерия кровь", "листерия пцр"],
    "фемофлор 16": ["фемофлор 16", "анализ фемофлор 16", "фемофлор 16 мазок", "фемофлор 16 пцр"],
    "фемофлор скрин": ["фемофлор скрин", "анализ фемофлор скрин", "фемофлор скрин мазок", "фемофлор скрин пцр"],
    "андрофлор": ["андрофлор", "анализ андрофлор", "андрофлор мазок", "андрофлор пцр"],
    "андрофлор скрин": ["андрофлор скрин", "анализ андрофлор скрин", "андрофлор скрин мазок", "андрофлор скрин пцр"],
    "бак посев мочи на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев мочи", "анализ бак посева мочи", "бак посев мочи микрофлора", "бак посев мочи антибиотики"],
    "бак посев вагинального содержимого на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев вагинального содержимого", "анализ бак посева вагинального содержимого", "бак посев вагинального содержимого микрофлора", "бак посев вагинального содержимого антибиотики"],
    "бак посев цервикального канала на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев цервикального канала", "анализ бак посева цервикального канала", "бак посев цервикального канала микрофлора", "бак посев цервикального канала антибиотики"],
    "бак посев уретры на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев уретры", "анализ бак посева уретры", "бак посев уретры микрофлора", "бак посев уретры антибиотики"],
    "бак посев спермы на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев спермы", "анализ бак посева спермы", "бак посев спермы микрофлора", "бак посев спермы антибиотики"],
    "бак посев из зева на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из зева", "анализ бак посева из зева", "бак посев из зева микрофлора", "бак посев из зева антибиотики"],
    "бак посев из полости рта на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из полости рта", "анализ бак посева из полости рта", "бак посев из полости рта микрофлора", "бак посев из полости рта антибиотики"],
    "бак посев из носа на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из носа", "анализ бак посева из носа", "бак посев из носа микрофлора", "бак посев из носа антибиотики"],
    "бак посев из парадонтального канала на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из парадонтального канала", "анализ бак посева из парадонтального канала", "бак посев из парадонтального канала микрофлора", "бак посев из парадонтального канала антибиотики"],
    "бак посев из конъюнктивы правого и левого глаза на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из конъюнктивы", "анализ бак посева из конъюнктивы", "бак посев из конъюнктивы микрофлора", "бак посев из конъюнктивы антибиотики"],
    "бак посев из правого уха на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из правого уха", "анализ бак посева из правого уха", "бак посев из правого уха микрофлора", "бак посев из правого уха антибиотики"],
    "бак посев из левого уха на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из левого уха", "анализ бак посева из левого уха", "бак посев из левого уха микрофлора", "бак посев из левого уха антибиотики"],
    "бак посев из раневой поверхности на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев из раневой поверхности", "анализ бак посева из раневой поверхности", "бак посев из раневой поверхности микрофлора", "бак посев из раневой поверхности антибиотики"],
    "бак посев желчи на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев желчи", "анализ бак посева желчи", "бак посев желчи микрофлора", "бак посев желчи антибиотики"],
    "бак посев грудного молока из левой и правой молочной железы на микрофлору+candida с определением чувствительности к антибиотикам": ["бак посев грудного молока", "анализ бак посева грудного молока", "бак посев грудного молока микрофлора", "бак посев грудного молока антибиотики"],
    "бак посев крови на стерильность с определением чувствительности к антибиотикам": ["бак посев крови на стерильность", "анализ бак посева крови на стерильность", "бак посев крови стерильность", "бак посев крови антибиотики"],
    "бак посев крови на гемокультуру (на тифы, паратиты) с определением чувствительности к антибиотикам": ["бак посев крови на гемокультуру", "анализ бак посева крови на гемокультуру", "бак посев крови гемокультура", "бак посев крови антибиотики"],
    "бак посев кала на носительство кишечной группы (сальмонелла и шигелла) с определением чувствительности к антибиотикам": ["бак посев кала на кишечную группу", "анализ бак посева кала на кишечную группу", "бак посев кала кишечная группа", "бак посев кала антибиотики"],
    "бак посев кала на дисбактериоз кишечника": ["бак посев кала на дисбактериоз", "анализ бак посева кала на дисбактериоз", "бак посев кала дисбактериоз", "бак посев кала микрофлора"],
    "обследование на носительство возбудителей кишечных инфекций: дизентерии, сальмонеллеза, брюшного тифа, паратитов а и в (для санитарных книжек)": ["обследование на кишечные инфекции", "анализ на кишечные инфекции", "кишечные инфекции обследование", "кишечные инфекции санитарная книжка"],
    "обследование на носительство патогенного стафилококка (для санитарных книжек)": ["обследование на стафилококк", "анализ на стафилококк", "стафилококк обследование", "стафилококк санитарная книжка"],
    "цитологическое исследование (с окраской по романовскому-гимзе, diff-qwik, май-грюнвальду, грамму, паппенгейму)": ["цитологическое исследование", "анализ цитологии", "цитология", "цитологическое исследование окраска"],
    "жидкостная цитология. исследование соскоба шейки матки и цервикального канала (окрашивание по папаниколау)": ["жидкостная цитология", "анализ жидкостной цитологии", "жидкостная цитология шейка матки", "жидкостная цитология цервикальный канал"],
    "беременность - пренатальный скрининг трисомий i триместра беременности (синдром дауна), prisca": ["пренатальный скрининг i триместр", "анализ пренатального скрининга i триместра", "скрининг i триместр", "пренатальный скрининг синдром дауна"],
    "беременность - пренатальный скрининг трисомий ii триместра беременности, prisca": ["пренатальный скрининг ii триместр", "анализ пренатального скрининга ii триместра", "скрининг ii триместр", "пренатальный скрининг трисомии"],
}

# Основная информация о компании
ADDRESS = "г. Алматы, ул. Розыбакиева 310А, ЖК 4YOU, вход при аптеке 888 PHARM"
ADDRESS_LINK = "https://go.2gis.com/wz9gi"
WORKING_HOURS = "Мы работаем ежедневно с 07:00 до 17:00."

def fetch_sheets_data():
    """Получение данных из Google Sheets."""
    try:
        sheets_credentials = os.getenv("GOOGLE_SHEETS_KEY")
        if not sheets_credentials:
            raise ValueError("GOOGLE_SHEETS_KEY не найден.")
        
        credentials_info = json.loads(sheets_credentials)
        credentials = Credentials.from_service_account_info(
            credentials_info,
            scopes=["https://www.googleapis.com/auth/spreadsheets"]
        )
        client = gspread.authorize(credentials)
        sheet = client.open_by_key(SPREADSHEET_ID).sheet1
        data = sheet.get_all_records()
        logger.info("Данные успешно получены из Google Sheets.")
        return data
    except Exception as e:
        logger.error(f"Ошибка при получении данных из Google Sheets: {e}")
        return None

def normalize_query(query):
    """Приведение запроса к стандартной форме с учетом синонимов."""
    query = query.lower().strip()
    for key, synonyms in ANALYSIS_SYNONYMS.items():
        if query in synonyms or query == key.lower():
            return key
    return query

def match_analysis(query, data):
    """Сопоставляет запрос клиента с базой анализов."""
    query = normalize_query(query)
    results = []
    for row in data:
        analysis_name = row.get('Название анализа', '').lower()
        if query in analysis_name:  # Поиск по нормализованному названию
            results.append(row)
    return results

# Ответы на часто задаваемые вопросы
async def handle_faq(update: Update, context):
    user_message = update.message.text.lower()

    if "привет" in user_message or "сәлем" in user_message:
        await update.message.reply_text("Здравствуйте! Чем могу помочь?")
    elif "адрес" in user_message:
        await update.message.reply_text(f"Наш адрес: {ADDRESS}\nСсылка на 2ГИС: {ADDRESS_LINK}")
    elif "режим работы" in user_message or "график" in user_message:
        await update.message.reply_text(WORKING_HOURS)
    elif "подготовка" in user_message:
        await update.message.reply_text(
            "Общие рекомендации:\n"
            "1. Не ешьте за 8-12 часов до сдачи крови.\n"
            "2. Избегайте физических нагрузок за день до анализа.\n"
            "3. Сообщите врачу о принимаемых лекарствах."
        )
    else:
        await handle_text_request(update, context)

# Обработка текстового запроса
async def handle_text_request(update: Update, context):
    user_message = update.message.text
    logger.info(f"Получено сообщение: {user_message}")
    
    try:
        data = fetch_sheets_data()
        if data:
            matched_results = match_analysis(user_message, data)
            if matched_results:
                response_text = "Найденные анализы:\n"
                for row in matched_results:
                    response_text += f"{row.get('Название анализа', 'Не указано')}: {row.get('Цена', 'Не указано')} тенге\n"
            else:
                response_text = "Анализы не найдены. Попробуйте уточнить запрос."
            await update.message.reply_text(response_text)
        else:
            await update.message.reply_text("Не удалось получить данные из Google Sheets.")
    except Exception as e:
        logger.error(f"Ошибка при обработке сообщения: {e}")
        await update.message.reply_text("Произошла ошибка. Попробуйте позже.")

# Обработка изображений с использованием OCR
async def handle_image_request(update: Update, context):
    # Код для OCR (распознавание текста из изображения)
    pass

# Обработка команды /start
async def start(update: Update, context):
    await update.message.reply_text("Добро пожаловать! Я ваш помощник по анализам.")

def main():
    telegram_token = os.getenv("BOT_TOKEN")
    if not telegram_token:
        logger.error("Ошибка: BOT_TOKEN не найден.")
        return
    
    app = ApplicationBuilder().token(telegram_token).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_faq))
    app.add_handler(MessageHandler(filters.PHOTO, handle_image_request))
    
    logger.info("Бот запущен.")
    app.run_polling()

if __name__ == "__main__":
    main()
